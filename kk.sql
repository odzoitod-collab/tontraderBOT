-- ==========================================
-- üß® 1. –û–ß–ò–°–¢–ö–ê (–°–ë–†–û–° –°–¢–ê–†–´–• –¢–ê–ë–õ–ò–¶)
-- ==========================================
DROP TABLE IF EXISTS public.user_promos;
DROP TABLE IF EXISTS public.promo_codes;
DROP TABLE IF EXISTS public.users;
DROP TABLE IF EXISTS public.settings;
DROP PUBLICATION IF EXISTS supabase_realtime;

-- ==========================================
-- üë§ 2. –¢–ê–ë–õ–ò–¶–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô (–ú–ê–ú–û–ù–¢–´)
-- ==========================================
CREATE TABLE public.users (
    user_id BIGINT PRIMARY KEY,              -- Telegram ID (–æ–±—â–∏–π –¥–ª—è –±–æ—Ç–∞ –∏ —Å–∞–π—Ç–∞)
    username TEXT,                           -- @username
    full_name TEXT,                          -- –ò–º—è
    photo_url TEXT,                          -- –ê–≤–∞—Ç–∞—Ä–∫–∞ –∏–∑ Telegram
    referrer_id BIGINT,                      -- ID –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–≥–æ (–¥–ª—è –≤–æ—Ä–∫–µ—Ä–∞)
    
    -- –§–∏–Ω–∞–Ω—Å—ã
    balance FLOAT DEFAULT 0,                 -- –ë–∞–ª–∞–Ω—Å
    
    -- –ò–≥—Ä–æ–≤–∞—è –º–µ—Ö–∞–Ω–∏–∫–∞
    luck TEXT DEFAULT 'default' CHECK (luck IN ('win', 'lose', 'default')),
    
    -- –°—Ç–∞—Ç—É—Å—ã –∏ –î–æ–ø. –ø–æ–ª—è
    is_kyc BOOLEAN DEFAULT FALSE,            -- –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è
    web_registered BOOLEAN DEFAULT FALSE,    -- –ó–∞—Ö–æ–¥–∏–ª –ª–∏ —á–µ—Ä–µ–∑ —Å–∞–π—Ç
    email TEXT DEFAULT '-',                  -- –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now())
);

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –º–∞–º–æ–Ω—Ç–æ–≤ —É –≤–æ—Ä–∫–µ—Ä–∞
CREATE INDEX idx_users_referrer ON public.users(referrer_id);

-- ==========================================
-- ‚öôÔ∏è 3. –¢–ê–ë–õ–ò–¶–ê –ù–ê–°–¢–†–û–ï–ö (–ê–î–ú–ò–ù–ö–ê)
-- ==========================================
CREATE TABLE public.settings (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    support_username TEXT DEFAULT 'etoooroSupport_Official',
    bank_details TEXT DEFAULT '–°–ë–ü: –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'
);

-- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø—É—Å—Ç–æ)
INSERT INTO public.settings (support_username, bank_details)
VALUES ('etoooroSupport_Official', '–°–ë–ü (–°–±–µ—Ä): –ü–µ—Ä–µ–≤–æ–¥ –ø–æ –Ω–æ–º–µ—Ä—É –∫–∞—Ä—Ç—ã...');

-- ==========================================
-- üìà 4. –¢–ê–ë–õ–ò–¶–ê –°–î–ï–õ–û–ö (TRADES)
-- ==========================================
CREATE TABLE public.trades (
    id TEXT PRIMARY KEY,                      -- UUID —Å–¥–µ–ª–∫–∏
    user_id BIGINT NOT NULL REFERENCES public.users(user_id),
    pair TEXT NOT NULL,                       -- –ù–∞–ø—Ä–∏–º–µ—Ä "TON/USDT"
    symbol TEXT NOT NULL,                     -- –ù–∞–ø—Ä–∏–º–µ—Ä "TON"
    type TEXT NOT NULL CHECK (type IN ('Long', 'Short')),
    amount FLOAT NOT NULL,                    -- –°—É–º–º–∞ —Å—Ç–∞–≤–∫–∏
    entry_price FLOAT NOT NULL,               -- –¶–µ–Ω–∞ –≤—Ö–æ–¥–∞
    start_time BIGINT NOT NULL,               -- Timestamp –Ω–∞—á–∞–ª–∞
    duration_seconds INT NOT NULL,            -- –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    leverage INT NOT NULL DEFAULT 1,          -- –ü–ª–µ—á–æ
    status TEXT DEFAULT 'active' CHECK (status IN ('active', 'completed', 'cancelled')),
    final_pnl FLOAT,                          -- –ò—Ç–æ–≥–æ–≤—ã–π PnL (–ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è)
    final_price FLOAT,                        -- –¶–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∏—è
    is_winning BOOLEAN,                       -- –í—ã–∏–≥—Ä–∞–ª –∏–ª–∏ –Ω–µ—Ç
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now())
);

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
CREATE INDEX idx_trades_user_active ON public.trades(user_id, status);

-- ==========================================
-- üí∞ 5. –¢–ê–ë–õ–ò–¶–ê –ó–ê–ü–†–û–°–û–í –ù–ê –ü–û–ü–û–õ–ù–ï–ù–ò–ï
-- ==========================================
CREATE TABLE public.deposit_requests (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES public.users(user_id),
    amount_rub FLOAT NOT NULL,                -- –°—É–º–º–∞ –≤ —Ä—É–±–ª—è—Ö
    amount_usd FLOAT NOT NULL,                -- –°—É–º–º–∞ –≤ USD (–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)
    method TEXT NOT NULL,                     -- –°–ø–æ—Å–æ–±: 'card' –∏–ª–∏ 'crypto'
    status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected')),
    worker_id BIGINT,                         -- ID –≤–æ—Ä–∫–µ—Ä–∞ (—Ä–µ—Ñ–µ—Ä–µ—Ä–∞)
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()),
    processed_at TIMESTAMP WITH TIME ZONE
);

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤–æ—Ä–∫–µ—Ä–∞
CREATE INDEX idx_deposit_requests_worker ON public.deposit_requests(worker_id, status);
CREATE INDEX idx_deposit_requests_user ON public.deposit_requests(user_id, status);

-- ==========================================
-- üéÅ 6. –¢–ê–ë–õ–ò–¶–´ –ü–†–û–ú–û–ö–û–î–û–í
-- ==========================================
CREATE TABLE public.promo_codes (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    code TEXT UNIQUE NOT NULL,            -- –ö–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "START500")
    reward_amount FLOAT NOT NULL,         -- –°—É–º–º–∞ –Ω–∞–≥—Ä–∞–¥—ã
    max_activations INT DEFAULT 100,      -- –õ–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π
    current_activations INT DEFAULT 0,    -- –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤–≤–µ–ª–∏
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now())
);

CREATE TABLE public.user_promos (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES public.users(user_id), -- –ö—Ç–æ –≤–≤–µ–ª
    promo_id BIGINT NOT NULL REFERENCES public.promo_codes(id), -- –ö–∞–∫–æ–π –∫–æ–¥
    activated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now())
);

-- –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥ "BONUS" –Ω–∞ 1000 –º–æ–Ω–µ—Ç
INSERT INTO public.promo_codes (code, reward_amount, max_activations)
VALUES ('BONUS', 1000, 10000);

-- ==========================================
-- ‚ö°Ô∏è 6. REALTIME (–ú–ì–ù–û–í–ï–ù–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï)
-- ==========================================
-- –í–∫–ª—é—á–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –±–∞–ª–∞–Ω—Å–∞, —Å–¥–µ–ª–æ–∫, –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ
CREATE PUBLICATION supabase_realtime FOR TABLE public.users, public.trades, public.settings, public.deposit_requests;

-- ==========================================
-- üîí 7. –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ (RLS - –ü–û–õ–ò–¢–ò–ö–ò)
-- ==========================================
ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.settings ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.promo_codes ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_promos ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.deposit_requests ENABLE ROW LEVEL SECURITY;

-- –ü–æ–ª–∏—Ç–∏–∫–∏ "–†–∞–∑—Ä–µ—à–∏—Ç—å –≤—Å—ë –≤—Å–µ–º" (–î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã WebApp –∏ –ë–æ—Ç–∞ –±–µ–∑ —Å–ª–æ–∂–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)

-- USERS
CREATE POLICY "Enable all for users" ON public.users FOR ALL USING (true) WITH CHECK (true);

-- SETTINGS
CREATE POLICY "Enable all for settings" ON public.settings FOR ALL USING (true) WITH CHECK (true);

-- DEPOSIT REQUESTS
CREATE POLICY "Enable all for deposit_requests" ON public.deposit_requests FOR ALL USING (true) WITH CHECK (true);

-- PROMO CODES
CREATE POLICY "Read Promos" ON public.promo_codes FOR SELECT USING (true);
CREATE POLICY "Update Promos" ON public.promo_codes FOR UPDATE USING (true); -- –ß—Ç–æ–±—ã –æ–±–Ω–æ–≤–ª—è—Ç—å —Å—á–µ—Ç—á–∏–∫
CREATE POLICY "Read User Promos" ON public.user_promos FOR SELECT USING (true);
CREATE POLICY "Insert User Promos" ON public.user_promos FOR INSERT WITH CHECK (true); -- –ß—Ç–æ–±—ã –∑–∞–ø–∏—Å–∞—Ç—å –≤–≤–æ–¥

-- TRADES
ALTER TABLE public.trades ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Enable all for trades" ON public.trades FOR ALL USING (true) WITH CHECK (true);

-- ==========================================
-- ‚úÖ –§–ò–ù–ê–õ
-- ==========================================
SELECT '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞! –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ë–æ—Ç, –°–∞–π—Ç –∏ –ü—Ä–æ–º–æ–∫–æ–¥—ã üöÄ' as status;