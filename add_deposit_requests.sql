-- ==========================================
-- üí∞ –î–û–ë–ê–í–õ–ï–ù–ò–ï –¢–ê–ë–õ–ò–¶–´ –ó–ê–ü–†–û–°–û–í –ù–ê –ü–û–ü–û–õ–ù–ï–ù–ò–ï
-- ==========================================

-- –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
CREATE TABLE IF NOT EXISTS public.deposit_requests (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES public.users(user_id),
    amount_rub FLOAT NOT NULL,                -- –°—É–º–º–∞ –≤ —Ä—É–±–ª—è—Ö
    amount_usd FLOAT NOT NULL,                -- –°—É–º–º–∞ –≤ USD (–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)
    method TEXT NOT NULL,                     -- –°–ø–æ—Å–æ–±: 'card' –∏–ª–∏ 'crypto'
    status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected')),
    worker_id BIGINT,                         -- ID –≤–æ—Ä–∫–µ—Ä–∞ (—Ä–µ—Ñ–µ—Ä–µ—Ä–∞)
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()),
    processed_at TIMESTAMP WITH TIME ZONE
);

-- –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã
CREATE INDEX IF NOT EXISTS idx_deposit_requests_worker ON public.deposit_requests(worker_id, status);
CREATE INDEX IF NOT EXISTS idx_deposit_requests_user ON public.deposit_requests(user_id, status);

-- –í–∫–ª—é—á–∞–µ–º RLS
ALTER TABLE public.deposit_requests ENABLE ROW LEVEL SECURITY;

-- –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –ø–æ–ª–∏—Ç–∏–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
DROP POLICY IF EXISTS "Enable all for deposit_requests" ON public.deposit_requests;

-- –°–æ–∑–¥–∞–µ–º –ø–æ–ª–∏—Ç–∏–∫—É
CREATE POLICY "Enable all for deposit_requests" 
ON public.deposit_requests 
FOR ALL 
USING (true) 
WITH CHECK (true);

-- –û–±–Ω–æ–≤–ª—è–µ–º publication –¥–ª—è realtime
-- –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é
DROP PUBLICATION IF EXISTS supabase_realtime;

-- –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å deposit_requests
CREATE PUBLICATION supabase_realtime FOR TABLE public.users, public.trades, public.settings, public.deposit_requests;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞
SELECT '–¢–∞–±–ª–∏—Ü–∞ deposit_requests —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞! ‚úÖ' as status;

SELECT 
    tablename,
    policyname,
    permissive,
    cmd
FROM pg_policies 
WHERE tablename = 'deposit_requests';
